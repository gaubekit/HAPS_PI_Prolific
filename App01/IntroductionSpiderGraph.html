{{ block title }}
    Stage 1: Introduction Spider Graph
{{ endblock }}

{{ block content }}
<!-- Chart.js für Radar Chart -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>

<style>
    .my-box {
        border: 1px solid #ccc;
        padding: 10px;
        background-color: #f9f9f9;
    }

    * {
        box-sizing: border-box;
    }

    .outer-container {
        width: 100%;
        height: 550px;
        display: flex;
    }

    .left-container {
        width: 60%;
        height: 100%;
        display: flex;
        overflow: auto;
        padding: 5px;
        flex-direction: column;
    }

    .right-container {
        width: 40%;
        height: 100%;
        padding: 20px;
        overflow-y: auto;
        font-family: Arial, sans-serif;
        font-size: 13px;

        display: flex;            /* Flexbox aktivieren */
        justify-content: center;  /* horizontal zentrieren */
        align-items: center;      /* vertikal zentrieren */
        text-align: center;       /* Text zentrieren, falls mehrzeilig */
    }

    .right-container h3 {
        margin-top: 15px;
        margin-bottom: 5px;
        font-size: 13px;
    }

    .right-container p {
        margin: 0 0 12px 0;
        font-size: 11px;
        line-height: 1.4;
    }

    #myRadarChart {
        width: 100% !important;
        height: 500px !important;
    }
</style>

<div class="my-box">
    <p>
        The <span style="color: rgba(54, 162, 235, 1);">blue line</span> shows how <span style="color: rgba(54, 162, 235, 1);">your</span> video meeting goals <!-- (chosen on the last page) -->look like in the <b>Spider Graph</b>, a multidimensional visualization:
        <br><br>

        <!-- The scale ranges, as in the questionnaire, from -3 in the center of the circle to +3 on the outside.
        Negative values indicate disagreement with a goal and positive values agreement, meaning that the more the graph is in the center, the more you disagree with the respective video meeting goal. -->
    </p>

    <div class="outer-container">
        <div class="left-container">
            <div id="radarChartContainer">
                <canvas id="myRadarChart"></canvas>
            </div>
        </div>

        <div class="right-container">
            <!-- Please note, when hovering with the mouse over the data points in the chart, you see a more detailed explanation of the related goal. -->
            <ul>
                <u>How to read the Spider Graph</u>
                <br><br>
                <li>Video meeting goals are given by your answers on the previous page.</li><br>
                <li>Hover over the data points to see the original explanation.</li><br>
                <li>negative values up to -3 in the center indicate disagreement with the respective goal.</li><br>
                <li>positive values up to +3 on the outside indicate agreement with the respective goal.</li><br>

            </ul>
        </div>
    </div>

    <br><br>
    <p><b>On the next page, you will have to wait until two more participants arrived to form a group (max 5 min)</b>.</p>

    <script>
        // Erklärungstexte der Ziele
        let goalDescriptions = {{ session.vm_goal_description }};

        // Plugin für gestrichelte konzentrische Kreise nur bei -3,0,3
        const customGridLinesPlugin = {
            beforeDraw: function(chart) {
                const ctx = chart.ctx;
                const scale = chart.scales['scale'];

                ctx.save();
                ctx.strokeStyle = '#ccc';
                ctx.lineWidth = 1;
                ctx.setLineDash([5, 5]);

                const showLinesAt = [-3, 0, 3];
                showLinesAt.forEach(val => {
                    const y = scale.getDistanceFromCenterForValue(val); // + 10 weg
                    ctx.beginPath();
                    ctx.arc(scale.xCenter, scale.yCenter, y, 0, 2 * Math.PI);
                    ctx.stroke();
                });

                ctx.restore();
            }
        };

        // Plugin für gestrichelte radiale Linien nur von -3 bis 3
        const customRadialLinesPlugin = {
            beforeDraw: function(chart) {
                const ctx = chart.ctx;
                const scale = chart.scales['scale'];
                const centerX = scale.xCenter;
                const centerY = scale.yCenter;

                ctx.save();
                ctx.strokeStyle = '#ccc';
                ctx.lineWidth = 1;
                ctx.setLineDash([5, 5]);

                const totalAxes = scale.pointLabels.length;
                for (let i = 0; i < totalAxes; i++) {
                    const angle = scale.getIndexAngle(i) - Math.PI / 2;

                    const rMin = scale.getDistanceFromCenterForValue(-3);
                    const rMax = scale.getDistanceFromCenterForValue(3);

                    const startX = centerX + rMin * Math.cos(angle);
                    const startY = centerY + rMin * Math.sin(angle);
                    const endX = centerX + rMax * Math.cos(angle);
                    const endY = centerY + rMax * Math.sin(angle);

                    ctx.beginPath();
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(endX, endY);
                    ctx.stroke();
                }

                ctx.restore();
            }
        };

        // Plugin für custom Tick Labels (nur einmal zwischen erster und zweiter radialer Linie)
        const customTickLabelsPlugin = {
            afterDraw: function(chart) {
                const ctx = chart.ctx;
                const scale = chart.scales['scale'];
                const centerX = scale.xCenter;
                const centerY = scale.yCenter;
                const pointLabelsCount = scale.pointLabels.length;
                const ticksToShow = [-3, 0, 3];

                ctx.save();
                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                // Wir nehmen den Winkel zwischen der ersten und zweiten radialen Linie
                // (also zwischen Index 0 und 1)
                let angle1 = scale.getIndexAngle(0) - Math.PI / 2;
                let angle2 = scale.getIndexAngle(1) - Math.PI / 2;
                let midAngle = (angle1 + angle2) / 2;

                ticksToShow.forEach(val => {
                    let r = scale.getDistanceFromCenterForValue(val) -10; // -10 hinzugefügt
                    let x = centerX + r * Math.cos(midAngle);
                    let y = centerY + r * Math.sin(midAngle);

                    ctx.fillText(val, x, y);
                });

                ctx.restore();
            }
        };

        function createRadarChart(total) {
            let ctx = document.getElementById('myRadarChart').getContext('2d');
            let myRadarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: {{ session.vm_goal_labels }},
                    datasets: [
                        {
                            label: 'Your Own Goals',
                            data: js_vars.own,
                            backgroundColor: 'transparent',  // Fläche nicht füllen
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scale: {
                        ticks: {
                            min: -4,
                            max: 3,
                            stepSize: 1,
                            beginAtZero: false,
                            display: false // komplette Deaktivierung der alten Tick-Beschriftungen
                        },
                        pointLabels: {
                            padding: 20,
                            fontSize: 12,
                            fontStyle: 'normal',
                            fontColor: '#666'
                        },
                        gridLines: {
                            display: false // wir zeichnen sie per Plugin
                        },
                        angleLines: {
                            display: false // wir zeichnen sie per Plugin
                        }
                    },
                    tooltips: {
                        callbacks: {
                            title: function(tooltipItems, data) {
                                let index = tooltipItems[0].index;
                                return data.labels[index];
                            },
                            label: function(tooltipItem, data) {
                                let index = tooltipItem.index;
                                return goalDescriptions[index];
                            }
                        }
                    },
                    hover: {
                        mode: 'nearest',
                        intersect: true
                    },
                    legend: {position: 'bottom', align: 'start', labels: {padding: 30}},
                    title: {
                        display: true,
                        text: 'Video Meeting Goals',
                        fontSize: 18,
                        fontStyle: 'bold',
                        padding: 20
                    }
                },
                plugins: [customGridLinesPlugin, customRadialLinesPlugin, customTickLabelsPlugin]
            });
        }

        createRadarChart(5);
    </script>
</div>

<br>

<!-- Countdown -->
<div id="countdown-container">
    <p>You can proceed in <span id="countdown-timer"></span> seconds.</p>
</div>

<!-- Next-Button -->
<div id="next-container" style="display: none;">
    <p>{{ next_button }}</p>
</div>


<script>
    const timeout_seconds = 45; // set minimum time

    document.addEventListener("DOMContentLoaded", function () {
        const countdownEl = document.getElementById("countdown-timer");
        let secondsLeft = timeout_seconds;

        // initial countdown-text
        countdownEl.textContent = secondsLeft;

        // update countdown
        const countdownInterval = setInterval(() => {
            secondsLeft -= 1;
            countdownEl.textContent = secondsLeft;

            if (secondsLeft <= 0) {
                clearInterval(countdownInterval);
                document.getElementById("countdown-container").style.display = "none";
                document.getElementById("next-container").style.display = "block";
            }
        }, 1000);
    });

    // Prevent page refresh (F5, Ctrl+R, Reload)
    document.addEventListener("keydown", function (e) {
        if ((e.key === "F5") || (e.ctrlKey && e.key === "r")) {
            e.preventDefault();
        }
    });
</script>

{{ endblock }}
