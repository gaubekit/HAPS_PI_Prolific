{% extends 'global/Page.html' %}

{% block title %} Virtual Team Meeting {% endblock %}

{% block content %}

<!-- ========================== -->
<!--        CSS Styling         -->
<!-- ========================== -->
<style>
  body {
    zoom: 90%;
  }
  .column {
    float: left;
    height: 80vh;
    box-sizing: border-box;
  }
  .left {
    width: 100%;
  }
  .row {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
  }
  .row:after {
    content: "";
    display: table;
    clear: both;
  }
  #meet {
    width: 100%;
    height: 100%;
  }
  .progress-bar-container {
    width: 100%;
    background-color: #f3f3f3;
    height: 30px;
    border: 1px solid #ccc;
    margin-top: 20px;
  }
  .progress-bar {
    width: 0%;
    height: 100%;
    background-color: #4caf50;
    text-align: center;
    line-height: 30px;
    color: white;
  }
</style>

<!-- ========================== -->
<!--     Introduction Text      -->
<!-- ========================== -->
<div id="introduction">
  <p>PLACEHOLDER: Hier kommt der Einleitungstext f√ºr die Teilnehmer.</p>
</div>

<!-- ========================== -->
<!--     Video Meeting Area     -->
<!-- ========================== -->
<div class="row">
  <div class="column left">
    <div id="meet"></div>
  </div>
</div>

<!-- ========================== -->
<!--     Progress Bar Timer     -->
<!-- ========================== -->
<div class="progress-bar-container">
  <div id="progressBar" class="progress-bar"></div>
</div>

<!-- Next Button -->
{{ next_button }}

<!-- ========================== -->
<!--   JavaScript & Jitsi API   -->
<!-- ========================== -->
<script src="https://haps-meeting.k8s.iism.kit.edu/external_api.js"></script>

<script>
  // Jitsi Meet Configuration
  const domain = "haps-meeting.k8s.iism.kit.edu";
  const userName = "Participant";
  const roomName = "VideoMeetingGroup{{ player.group_id }}";

  const options = {
    roomName: roomName,
    parentNode: document.querySelector('#meet'),
    configOverwrite: {
      prejoinConfig: { enabled: false },
      startWithAudioMuted: false,
      startWithVideoMuted: false,
      resolution: 480,
      constraints: {
        video: { height: { ideal: 480, max: 480, min: 240 } }
      },
      enableLayerSuspension: true
    },
    interfaceConfigOverwrite: {
      TOOLBAR_BUTTONS: ['microphone', 'camera', 'fodeviceselection'],
      SHOW_JITSI_WATERMARK: false,
      SHOW_MEETING_NAME: false,
      TILE_VIEW_ENABLED: true
    },
    userInfo: {
      displayName: userName
    }
  };

  const api = new JitsiMeetExternalAPI(domain, options);

  // Enable tile view once participant joins
  api.addEventListener('videoConferenceJoined', () => {
    api.executeCommand('setTileView', true);
  });

  // ================================
  //   Audio Recording and Upload
  // ================================
  let audioRecorder, displayRecorder;
  let audioChunks = [], displayChunks = [];

  async function startRecording() {
    const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const displayStream = await navigator.mediaDevices.getDisplayMedia({ audio: true, video: true });

    audioRecorder = new MediaRecorder(audioStream);
    displayRecorder = new MediaRecorder(displayStream);

    audioRecorder.ondataavailable = e => audioChunks.push(e.data);
    displayRecorder.ondataavailable = e => displayChunks.push(e.data);

    audioRecorder.start();
    displayRecorder.start();

    // Stop screen sharing immediately to avoid screen capture (keep only tab audio)
    displayStream.getTracks().forEach(track => {
      if (track.kind === 'video') track.stop();
    });
  }

  async function stopAndUpload() {
    audioRecorder.stop();
    displayRecorder.stop();

    audioRecorder.onstop = () => uploadBlob(audioChunks, '/upload/audio/noOptIn');
    displayRecorder.onstop = () => uploadBlob(displayChunks, '/upload/audio/noOptIn');
  }

  function uploadBlob(chunks, url) {
    const blob = new Blob(chunks, { type: 'audio/webm' });
    const formData = new FormData();
    formData.append('audio_data', blob);
    formData.append('participant_id', '{{ player.participant.code }}');
    fetch(url, {
      method: 'POST',
      body: formData
    }).then(res => console.log("Upload complete"));
  }

  // ================================
  //       Countdown Timer Logic
  // ================================
  let totalTime = 7 * 60; // 7 minutes in seconds
  function startProgressBar(duration) {
    const bar = document.getElementById('progressBar');
    let timePassed = 0;
    const interval = setInterval(() => {
      timePassed++;
      let percent = (timePassed / duration) * 100;
      bar.style.width = percent + '%';

      if (timePassed >= duration - 121) { // At ~5 min mark
        stopAndUpload();
        api.dispose(); // End the video call
        clearInterval(interval);
      }
    }, 1000);
  }

  // Prevent F5 or Ctrl+R reloads
  window.addEventListener('keydown', function (e) {
    if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
      e.preventDefault();
    }
  });

  // Start recording and progress bar when page loads
  document.addEventListener('DOMContentLoaded', function () {
    startRecording();
    startProgressBar(totalTime);
  });
</script>

{% endblock %}
