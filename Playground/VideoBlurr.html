{{ extends 'global/Page.html' }}
{{ block title }}Meet Your Team!{{ endblock }}

{{ block content }}

<style>
    .row {
        display: flex;
        flex-wrap: wrap;
        max-width: 1200px;
        margin: 0 auto;
    }
    .column {
        flex: 1;
        min-width: 300px;
        box-sizing: border-box;
        padding: 10px;
    }
    .left-box {
        background-color: #f9f9f9;
        border: 1px solid #ccc;
        padding: 20px;
        height: 80vh;
        overflow-y: auto;
    }
    .right-box {
        border: 1px solid #ccc;
        height: 80vh;
    }
    #meet {
        width: 100%;
        height: 100%;
    }
    input[type="checkbox"] {
        margin-right: 10px;
    }
    @media (max-width: 768px) {
        .row {
            flex-direction: column;
        }
        .left-box, .right-box {
            height: auto;
        }
    }
</style>


<div class="column right-box">
    <div id="meet"></div>
</div>


<br><br>

{{ next_button }}

<!-- External Jitsi Script -->
<script src="https://haps-meeting.k8s.iism.kit.edu/external_api.js"></script>

<script>
    // --- Basic settings ---
    const domain = "haps-meeting.k8s.iism.kit.edu";
    const TN_name = "P" + {{ player.id_in_group }};

    // Get the full static path to the background image
    const backgroundImageUrl = "{{ static 'black.jpeg' }}";

    // --- Jitsi options ---
    const options = {
        roomName: "Video Meeting" + {{ player.group_id }},
        parentNode: document.querySelector('#meet'),
        userInfo: {
            displayName: TN_name,
        },
        configOverwrite: {
            prejoinConfig: { enabled: false },
            disableSelfView: false,
            startWithAudioMuted: false,
            startWithVideoMuted: false,
            resolution: 480,
            filmstrip: { disableResizable: true },
            participantsPane: {
                hideModeratorSettingsTab: true,
                hideMoreActionsButton: true,
                hideMuteAllButton: true,
            },
            constraints: {
                video: {
                    height: {
                        ideal: 480,
                        max: 480,
                        min: 240
                    }
                }
            },
            enableLayerSuspension: true,
            disableSimulcast: false,
        },
        interfaceConfigOverwrite: {
            TOOLBAR_BUTTONS: ['microphone', 'camera', 'fodeviceselection'],
            SHOW_JITSI_WATERMARK: false,
            SHOW_MEETING_NAME: false,
            SHOW_MEETING_TIMER: false,
            TILE_VIEW_ENABLED: true,
            TILE_VIEW_MAX_COLUMNS: 2,
            PARTICIPANT_MENU_BUTTONS: []  // No menu for participants
        }
    };

    // --- Initialize Jitsi API ---
    const api = new JitsiMeetExternalAPI(domain, options);

    // --- On successful conference join ---
    api.addEventListener('videoConferenceJoined', () => {
        // Enable tile view
        api.executeCommand('setTileView', true);

        // Attempt to apply custom background image
        api.executeCommand('toggleBackgroundEffect', {
            enabled: true,
            selectedEffect: 'image',
            url: backgroundImageUrl
        });

        // Fallback attempt in case background isn't set immediately
        setTimeout(() => {
            api.executeCommand('toggleBackgroundEffect', {
                enabled: true,
                selectedEffect: 'image',
                url: backgroundImageUrl
            });
        }, 2000);  // Re-apply after 2s
    });

    // Optionally, hide UI elements if needed (currently done above via config)
</script>


{{ endblock }}
