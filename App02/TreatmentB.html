{{ block title }}
    Stage 2: Team Goals
{{ endblock }}

{{ block content }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>

<style>
    .my-box {
        border: 1px solid #ccc;
        padding: 10px;
        background-color: #f9f9f9;
    }

    * {
        box-sizing: border-box;
    }

    .outer-container {
        width: 100%;
        height: 550px;
        display: flex;
    }

    .left-container {
        width: 60%;
        height: 100%;
        display: flex;
        overflow: auto;
        padding: 5px;
        flex-direction: column;
    }

    .right-container {
        width: 40%;
        height: 100%;
        padding: 20px;
        overflow-y: auto;
        font-family: Arial, sans-serif;
        font-size: 14px;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        flex-direction: column;
    }

    .right-container p {
        margin: 0 0 12px 0;
        font-size: 14px;
        line-height: 1.4;
    }

    #audio-timer {
        font-weight: bold;
        margin-top: 10px;
        font-size: 14px;
    }

    #play-audio-btn {
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 14px;
    }

    #progress-container {
        width: 100%;
        margin-top: 15px;
        display: none;
    }

    #audio-progress {
        width: 100%;
        height: 10px;
    }

    #notes-field {
        margin-top: 15px;
        width: 100%;
        display: none;
    }

    #notes-field textarea {
        width: 100%;
        height: 100px;
        font-size: 13px;
        padding: 8px;
    }

    #myRadarChart {
        width: 100% !important;
        height: 500px !important;
    }
</style>

<div class="my-box">
    <p>
        You have been matched with two other participants. As before, the <span style="color: rgba(54, 162, 235, 1);">blue line</span> shows <span style="color: rgba(54, 162, 235, 1);">your</span> video meeting goals in the spider graph.
        Additionally, the <span style="color: rgba(255, 99, 132, 1);">red line</span> shows the <u>average</u> video meeting goals of the <span style="color: rgba(255, 99, 132, 1);">other team members</span>.
    </p>

    <div class="outer-container">
        <div class="left-container">
            <div id="radarChartContainer">
                <canvas id="myRadarChart"></canvas>
            </div>
        </div>

        <div class="right-container">
            <div id="instruction-container">
                <p>Please take a moment to consider <span style="color: rgba(54, 162, 235, 1);">your goals</span> and your <span style="color: rgba(255, 99, 132, 1);">team members' goals</span>.</p>
                <p>After {{ C.AUDIO_GUIDE_APPEAR }} seconds, a play button will become visible. Click the button and follow the audio instructions.</p>
            </div>

            <div id="instruction-container-updated" style="display:none;">
                <p>Please take a moment to consider <span style="color: rgba(54, 162, 235, 1);">your goals</span> and your <span style="color: rgba(255, 99, 132, 1);">team members' goals</span>.</p>
                <p>
                    Click the button as soon as you're ready and follow the audio instructions.
                    The audio will automatically start in <span id="auto-start-timer">{{ C.AUDIO_GUIDE_AUTO_SUBMIT }}</span> seconds.
                </p>
            </div>

            <div id="instruction-container-off" style="display:none;">
                <p>Please follow the audio instructions.</p>
            </div>

            <div id="audio-timer">{{ C.AUDIO_GUIDE_APPEAR }} seconds remaining...</div>

            <button type="button" id="play-audio-btn" style="display:none;">▶ Play Audio Instruction</button>

            <div id="progress-container">
                <progress id="audio-progress" value="0" max="1"></progress>
            </div>

            <div id="notes-field">
                <label for="notes">Your notes:</label><br>
                <textarea id="notes" name="treatment_notes" placeholder="Write down your reflections here..."></textarea>
            </div>

            <audio id="audio-player" src="{% static 'audio/WOOP_your_SpiderGraph.mp3' %}"></audio>
        </div>
    </div>
    <br>
    Please <u>do not</u> refresh this page!
</div>

<br>

<!-- Countdown for NEXT button -->
<div>
    <!-- Statushinweis -->
    <div id="countdown-container">
        <p style="color: gray; font-style: italic;">
            The Next-Button will become available after the audio guide concludes.
        </p>
    </div>

    <!-- Next-Button -->
    <div id="next-container" style="display: none; text-align: left; margin-top: 20px;">
        <p>{{ next_button }}</p>
    </div>
</div>

<script>
    // trigger repeatedly otree live_methode
     setInterval(() => {
            liveSend("ping");
        }, 800);
</script>


<script>
    const goalDescriptions = {{ session.vm_goal_description }};
    const customGridLinesPlugin = {
            beforeDraw: function(chart) {
                const ctx = chart.ctx;
                const scale = chart.scales['scale'];

                ctx.save();
                ctx.strokeStyle = '#ccc';
                ctx.lineWidth = 1;

                const showLinesAt = [-3, 0, 3];
                showLinesAt.forEach(val => {
                    // Prüfen, ob äußerste oder innerste Linie
                    if (val === -3 || val === 3) {
                        ctx.setLineDash([]); // durchgezogen
                    } else {
                        ctx.setLineDash([5, 5]); // gestrichelt
                    }

                    const y = scale.getDistanceFromCenterForValue(val);
                    ctx.beginPath();
                    ctx.arc(scale.xCenter, scale.yCenter, y, 0, 2 * Math.PI);
                    ctx.stroke();
                });

                ctx.restore();
            }
        };

        const customRadialLinesPlugin = {
            beforeDraw(chart) {
                const ctx = chart.ctx;
                const scale = chart.scales['scale'];
                const cx = scale.xCenter;
                const cy = scale.yCenter;
                ctx.save();
                ctx.strokeStyle = '#ccc';
                ctx.lineWidth = 1;
                ctx.setLineDash([5, 5]);
                const totalAxes = scale.pointLabels.length;
                for (let i = 0; i < totalAxes; i++) {
                    const angle = scale.getIndexAngle(i) - Math.PI / 2;
                    const rMin = scale.getDistanceFromCenterForValue(-3);
                    const rMax = scale.getDistanceFromCenterForValue(3);
                    ctx.beginPath();
                    ctx.moveTo(cx + rMin * Math.cos(angle), cy + rMin * Math.sin(angle));
                    ctx.lineTo(cx + rMax * Math.cos(angle), cy + rMax * Math.sin(angle));
                    ctx.stroke();
                }
                ctx.restore();
            }
        };
        const customTickLabelsPlugin = {
            afterDraw(chart) {
                const ctx = chart.ctx;
                const scale = chart.scales['scale'];
                const cx = scale.xCenter;
                const cy = scale.yCenter;
                ctx.save();
                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const angle1 = scale.getIndexAngle(0) - Math.PI / 2;
                const angle2 = scale.getIndexAngle(1) - Math.PI / 2;
                const midAngle = (angle1 + angle2) / 2;
                [-3, 0, 3].forEach(val => {
                    const r = scale.getDistanceFromCenterForValue(val) -10;
                    const x = cx + r * Math.cos(midAngle);
                    const y = cy + r * Math.sin(midAngle);
                    ctx.fillText(val, x, y);
                });
                ctx.restore();
            }
        };

    function createRadarChart() {
        const ctx = document.getElementById('myRadarChart').getContext('2d');
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: {{ session.vm_goal_labels }},
                datasets: [
                    {
                        label: 'Your Own Goals',
                        data: js_vars.own,
                        backgroundColor: 'transparent',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                        fill: false
                    },
                    {
                        label: 'Average Goals of Others',
                        data: js_vars.other,
                        backgroundColor: 'transparent',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(255, 99, 132, 1)',
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scale: {
                    ticks: {
                        min: -4,
                        max: 3,
                        stepSize: 1,
                        display: false
                    },
                    pointLabels: {
                        padding: 20,
                        fontSize: 12,
                        fontStyle: 'normal',
                        fontColor: '#666'
                        },
                    gridLines: { display: false },
                    angleLines: { display: false }
                },
                tooltips: {
                    callbacks: {
                        title(tip, data) {
                            return data.labels[tip[0].index];
                        },
                        label(tip) {
                            return goalDescriptions[tip.index];
                        }
                    }
                },
                hover: { mode: 'nearest', intersect: true },
                legend: {position: 'bottom', align: 'start', labels: {padding: 30}},
                title: {
                    display: true,
                    text: 'Video Meeting Goals',
                    fontSize: 18,
                    fontStyle: 'bold',
                    padding: 20
                }
            },
            plugins: [customGridLinesPlugin, customRadialLinesPlugin, customTickLabelsPlugin ]
        });
    }

    createRadarChart();

    // Variablen aus Backend
    const appearDelay = {{ C.AUDIO_GUIDE_APPEAR }};
    const autoSubmitDelay = {{ C.AUDIO_GUIDE_AUTO_SUBMIT }};

    const timerEl = document.getElementById("audio-timer");
    const playBtn = document.getElementById("play-audio-btn");
    const audioEl = document.getElementById("audio-player");
    const progressContainer = document.getElementById("progress-container");
    const progressBar = document.getElementById("audio-progress");
    const notesField = document.getElementById("notes-field");
    const instructionContainer = document.getElementById("instruction-container");
    const instructionContainerUpdated = document.getElementById("instruction-container-updated");
    const instructionContainerOff = document.getElementById("instruction-container-off");
    const countdownContainer = document.getElementById("countdown-container");
    const nextContainer = document.getElementById("next-container");

    // Countdown bis Play-Button erscheint
    let countdown = appearDelay;
    const countdownInterval = setInterval(() => {
        countdown--;
        timerEl.textContent = countdown + " seconds remaining...";
        if (countdown <= 0) {
            clearInterval(countdownInterval);
            timerEl.style.display = "none";
            playBtn.style.display = "inline-block";
            instructionContainer.style.display = "none";
            instructionContainerUpdated.style.display = "block";

            // Auto-Start Countdown anzeigen
            let autoCountdown = autoSubmitDelay;
            const autoStartTimerEl = document.getElementById("auto-start-timer");
            const autoInterval = setInterval(() => {
                autoCountdown--;
                if (autoCountdown >= 0) {
                    autoStartTimerEl.textContent = autoCountdown;
                }
                if (autoCountdown <= 0) {
                    clearInterval(autoInterval);
                }
            }, 1000);

            // Auto-Start nach autoSubmitDelay
            setTimeout(() => {
                if (playBtn.style.display !== "none") {
                    startAudio();
                }
            }, autoSubmitDelay * 1000);
        }
    }, 1000);

    function startAudio() {
        playBtn.style.display = "none";
        instructionContainerUpdated.style.display = "none";
        instructionContainerOff.style.display = "block";
        progressContainer.style.display = "block";
        notesField.style.display = "block";
        audioEl.play();
    }

    playBtn.addEventListener("click", startAudio);

    // Progress-Bar updaten
    audioEl.addEventListener("timeupdate", () => {
        if (audioEl.duration) {
            progressBar.value = audioEl.currentTime / audioEl.duration;
        }
    });

    // Nach Ende der Audio -> Hinweis ausblenden, Next-Button einblenden
      audioEl.addEventListener("ended", () => {
        countdownContainer.style.display = "none";   // Statushinweis ausblenden
        nextContainer.style.display = "block";       // Next-Button einblenden
    });

    // Prevent page refresh
    document.addEventListener("keydown", function (e) {
        if ((e.key === "F5") || (e.ctrlKey && e.key === "r")) {
            e.preventDefault();
        }
    });
</script>

{{ endblock }}
