{{ extends 'global/Page.html' }}
{{ block title }}Meet Your Team!{{ endblock }}

{{ block content }}

<style>
    .row {
        display: flex;
        flex-wrap: wrap;
        max-width: 1200px;
        margin: 0 auto;
    }
    .column {
        flex: 1;
        min-width: 300px;
        box-sizing: border-box;
        padding: 10px;
    }
    .left-box {
        background-color: #f9f9f9;
        border: 1px solid #ccc;
        padding: 20px;
        height: 80vh;
        overflow-y: auto;
    }
    .right-box {
        border: 1px solid #ccc;
        height: 80vh;
    }
    #meet {
        width: 100%;
        height: 100%;
    }
    input[type="checkbox"] {
        margin-right: 10px;
    }
    @media (max-width: 768px) {
        .row {
            flex-direction: column;
        }
        .left-box, .right-box {
            height: auto;
        }
    }
</style>

<div class="row">
    <!-- LEFT: Text + Checkbox -->
    <div class="column left-box">
        <p>
            On this page you will meet your team virtually.
            <br><br>
            Imagine that the three of you have to work over the next week on a joint project. The success of this project will depend on the effort the team puts into this project. We will ask you on the next page how much effort you would like to put into the team project.
            <br><br>
            Now, use the video meeting to get to know your team. You can use the next 7 minutes for small talk (e.g.: Talk about holiday preferences)
            <br><br>
            In your own interest, please, avoid to talk about anything that is related to the team project and your personal goals.
            <br><br>
            The meeting starts after all players have checked the box below:
        </p>

        <label>
            <input type="checkbox" id="agreement" onclick="sendAgreement(this)">
            <b>I confirm that I will only talk about unrelated topics (e.g. holiday preferences)</b>
        </label>
    </div>

    <!-- RIGHT: Jitsi Video -->
    <div class="column right-box">
        <div id="meet" style="display: none"></div>
    </div>
</div>

<br><br>

{{ next_button }}

<!-- External Jitsi Script -->
<script src="https://haps-meeting.k8s.iism.kit.edu/external_api.js"></script>

<script>


    // using haps server
    const domain = "haps-meeting.k8s.iism.kit.edu";
    const TN_name = "P" + {{ player.id_in_group }};

    const options = {
        roomName: "Video Meeting" + {{ player.group_id }},
        parentNode: document.querySelector('#meet'),
        configOverwrite: {
            prejoinConfig: { enabled: false },
            disableSelfView: false,
            startWithAudioMuted: false,
            startWithVideoMuted: false,
            filmstrip: { disableResizable: true },
            participantsPane: {
                hideModeratorSettingsTab: true,
                hideMoreActionsButton: true,
                hideMuteAllButton: true
            },
            resolution: 480,
            disableAEC: false,
            disableNS: false,
            constraints: {
                video: {
                    height: {
                        ideal: 480,
                        max: 480,
                        min: 240
                    }
                }
            },
            disableSimulcast: false,
            enableLayerSuspension: true
        },
        interfaceConfigOverwrite: {
            TOOLBAR_BUTTONS: ['microphone', 'camera', 'fodeviceselection'],
            SHOW_JITSI_WATERMARK: false,
            SHOW_MEETING_NAME: false,
            SHOW_MEETING_TIMER: false,
            TILE_VIEW_MAX_COLUMNS: 2,
            TILE_VIEW_ENABLED: true,
            PARTICIPANT_MENU_BUTTONS: []
        },
        userInfo: {
            displayName: TN_name,
        }
    };

    const api = new JitsiMeetExternalAPI(domain, options);

    api.addEventListener('videoConferenceJoined', () => {
        api.executeCommand('setTileView', true);
        api.executeCommand('toggleBackgroundEffect', {
            enabled: true,
            selectedEffect: 'blur',
        });
    });

    // Checks whether Checkbox is clicked, sends info to backend and locks the checkbox
    function sendAgreement(checkbox) {
    if (checkbox.checked) {
        liveSend(true);
        checkbox.disabled = true;
        }
    else {
        liveSend(false);
        }
    }

    // get data from backend - if all_agreed === True -> display video meeting
    function liveRecv(data) {
        if (data) {
            document.getElementById("meet").style.display = "inline-block";
        }
    }


    // block F5 oder Ctrl+R / Cmd+R
    window.addEventListener("keydown", function (e) {
        if (
            (e.key === "F5") ||
            ((e.ctrlKey || e.metaKey) && e.key === "r")
        ) {
            e.preventDefault();
        }
    });
</script>

{{ endblock }}
