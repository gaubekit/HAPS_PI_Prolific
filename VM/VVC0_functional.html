{{ extends 'global/Page.html' }}
{{ block title }}Technical Check: Video Meeting{{ endblock }}

{{ block content }}

<style>
    .column {
        float: left;
        height: 80vh;
        box-sizing: border-box;
    }
    .left {
        width: 100%;
    }
    .right {
        width: 20%;
        vertical-align: middle;
        border: 1px solid #000;
    }
    .row {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
    }
    .row:after {
        content: "";
        display: table;
        clear: both;
    }
    #meet {
        width: 100%;
        height: 100%;
    }
    table {
        width: 100%;
        border-collapse: collapse;
    }
    th, td {
        text-align: center;
        vertical-align: middle;
        padding: 10px;
        position: relative;
    }
    th:not(:last-child), td:not(:last-child) {
        border-right: 1px solid grey;
    }
    th, td {
        border-bottom: 1px solid grey;
    }
    input[type="checkbox"] {
        display: block;
        margin: 0 auto;
    }
    @media (max-width: 1200px) {
        .row {
            max-width: 1000px;
        }
    }
    @media (max-width: 1000px) {
        .row {
            max-width: 800px;
        }
    }
    @media (max-width: 800px) {
        .row {
            max-width: 600px;
        }
    }
    @media (max-width: 600px) {
        .row {
            max-width: 100%;
        }
        .column {
            float: none;
            width: 100%;
            height: auto;
        }
        .left, .right {
            width: 100%;
        }
        .right {
            margin-top: 20px;
            border: none;
        }
    }
    containerbox {
        width: 300px;
        padding: 20px;
        border: 2px solid #ccc;
        margin: 0 auto;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100px;
    }
</style>

<div id="message"></div>
This is a test video call. <br/><br/>
<p><b>1) Please join the Jitsi Meeting. Your video will automatically use a blurred background. <br/>
    This background is mandatory to participate and get paid.</b></p>
<p><b>2) Please make sure your audio output, microphone and camera are functioning properly.
    If not, please choose the appropriate device from the toolbar options at the bottom of the video call.</b></p>
<p><b>3) If your camera or microphone is not functioning properly, please make sure you have allowed microphone and camera access in your browser settings (Click Browser Settings or to the Left of the address bar).</b></p>

<div class="row">
    <div class="column left">
        <div id="meet"></div>
    </div>
</div>

<br/>
<br/>
{{ next_button }}

<script src="https://haps-meeting.k8s.iism.kit.edu/external_api.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/highcharts-more.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
    const domain = "haps-meeting.k8s.iism.kit.edu";
    const TN_name = "P" + {{ player.id_in_group }};

    const options = {
        roomName: "Video Meeting" + {{ player.group_id }},
        parentNode: document.querySelector('#meet'),
        configOverwrite: {
            prejoinConfig: {
                enabled: false
            },
            disableSelfView: false,
            startWithAudioMuted: false,
            startWithVideoMuted: false,
            filmstrip: {
                disableResizable: true,
            },
            participantsPane: {
                hideModeratorSettingsTab: true,
                hideMoreActionsButton: true,
                hideMuteAllButton: true
            },
            resolution: 480,
            disableAEC: false,
            disableNS: false,
            constraints: {
                video: {
                    height: {
                        ideal: 480,
                        max: 480,
                        min: 240
                    }
                }
            },
            disableSimulcast: false,
            enableLayerSuspension: true
        },
        interfaceConfigOverwrite: {
            TOOLBAR_BUTTONS: ['microphone', 'camera', 'fodeviceselection'],
            SHOW_JITSI_WATERMARK: false,
            SHOW_MEETING_NAME: false,
            SHOW_MEETING_TIMER: false,
            TILE_VIEW_MAX_COLUMNS: 2,
            TILE_VIEW_ENABLED: true,
            PARTICIPANT_MENU_BUTTONS: []
        },
        userInfo: {
            displayName: TN_name,
        }
    }

    const api = new JitsiMeetExternalAPI(domain, options);

    api.addEventListener('videoConferenceJoined', () => {
        api.executeCommand('setTileView', true);

        // Hintergrund automatisch auf "blur" setzen
        api.executeCommand('toggleBackgroundEffect', {
            enabled: true,
            selectedEffect: 'blur',
        });
    });

    // Debug-Ausgabe
    console.debug("Player ID:", {{ player.id_in_group }});

</script>

{{ endblock }}
