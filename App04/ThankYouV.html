{{ extends 'global/Page.html' }}

{{ block title }}End of Study: Feedback and Payoff Information {{ endblock }}

{{ block content }}
    <style>
        .my-box {
                    border: 1px solid #ccc;
                    padding: 10px;
                    background-color: #f9f9f9;
                }
    </style>

    <div class="my-box">
        <h5>Thank you for participating in this study.</h5>


        {{ formfield 'feedback' }}

        <hr>

        <p>
            <h5 style="text-align: center;">Payoff Formula: Payoff = Fixed Payoff + Bonus Payoff + Compensation</h5>
            <h5 style="text-align: center;">Payoff Conversion: 10 ECU = £0.2</h5>
        </p>

        <hr>

        <h6><u>Your Payoff:</u></h6>
         <ul>
            <li>In this study, <b>you earned in total {{ participant.payoff_total }} ECU (£{{ player.payoff_total_pound }})</b>.
            </li>
         </ul>

        <h6><u>Fixed Payoff:</u></h6>
        <ul>
            <li>{{ participant.payoff_fix }} ECU (£{{ payoff_fix_pound }}) for completing the study</li>
        </ul>
        <h6><u>Bonus Payoff:</u></h6>
        <ul>
            <li>{{ participant.payoff_bonus_svo }} ECU (£{{ payoff_bonus_svo_pound }}) for Stage 1, where you allocated {{ participant.svo_to_self }} ECU to you and received {{ participant.svo_from_other }} ECU from the other.</li>
            <li>{{ participant.payoff_bonus_wlg }} ECU (£{{ payoff_bonus_wlg_pound }}) for Stage 2, where your contribution was {{ participant.wlg_own_choice }} hours and the minimum contribution {{ participant.wlg_min_choice }} hours.</li>
            <br>
            <!-- Payoff Table image -->
            <img src="{{ static 'images/payoff_table.png' }}" width="80%" alt="Payoff Table" />
        </ul>

         <h6><u>Compensation:</u></h6>
        <ul>
            <li>{{ participant.payoff_compensation_wait }} ECU (£{{ payoff_compensation_wait_pound }}) for your additional wait time, because you extended the wait period {{ participant.additional_wait_time }} times. (each extension = 15 ECU)</li>
        </ul>

        <hr>

        <p>
            We will transfer the £{{ player.payoff_total_pound }} to your Prolific account with the ID {{ participant.prolific_id }} within the next days.<br>
        </p>
        Please use the button below to return to Prolific.
    </div>

    <br>

  {{ next_button }}

<script>
document.addEventListener('DOMContentLoaded', () => {
    // URL aus den Constants (ersetze ggf. den Namen)
    const redirectUrl = "{{ C.PROLIFIC_RETURN_LINK }}";

    const form = document.querySelector('form');
    const nextBtn = document.querySelector('.otree-btn-next');

    // Button-Text anpassen (optional)
    if (nextBtn) nextBtn.textContent = "Return to Prolific";

    if (!form) return;

    form.addEventListener('submit', async (ev) => {
        ev.preventDefault(); // verhindern, dass Browser direkt navigiert

        try {
            // CSRF token: aus dem hidden input holen (oTree / Django fügt das ein)
            const csrfInput = form.querySelector('input[name="csrfmiddlewaretoken"]');
            const csrfToken = csrfInput ? csrfInput.value : null;

            // FormData enthält alle formfields (inkl. oTree-hidden fields)
            const formData = new FormData(form);

            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                credentials: 'same-origin',
                headers: csrfToken ? { 'X-CSRFToken': csrfToken } : {}
            });

            if (response.ok) {
                // Submission war erfolgreich — jetzt extern weiterleiten
                window.location.href = redirectUrl;
            } else {
                // Server-Antwort nicht OK -> Fehler anzeigen / fallback
                console.error('Submission failed (status):', response.status);
                // Fallback: normales Formular abschicken (führt evtl. zu oTree-Next-Seite)
                form.submit();
            }
        } catch (err) {
            console.error('Error during submission:', err);
            // in case nothing works: normal submit
            form.submit();
        }
    });
});
</script>

{{ endblock }}
